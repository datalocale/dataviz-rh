History=function(){this.hCount=0;this.history=new Array();this.bSaveHistoryState=true;ddCtrl.addChartModelReadyListener(this);ddCtrl.addCurrentPageLoadListener(this);};History.prototype.onChartModelReady=function(doc,dm,dmsel,chart){this.commitInitialState(doc,dm,dmsel,chart);};History.prototype.currentPageLoaded=function(pageId){this.createState(pageId,false);};History.prototype.setInitialState=function(dashboardState){var state=new State();state.pageId=dashboardState.page;var filters=dashboardState.filters;if(filters){for(var i=0;i<filters.length;i++){var filter=filters[i];var fs=new FilterHistory(filter.dimension,filter.hierarchy,filter.level,filter.members,filter.membersFormated,filter.min,filter.max,null,null,filter.minFormula,filter.maxFormula,filter.exclude);state.filtersByDim[filter.dimension]=fs;}}var charts=dashboardState.charts;if(charts){for(var i=0;i<charts.length;i++){var chart=charts[i];var frameId=chart.id;var drills=chart.drills;for(var j=0;j<drills.length;j++){var drill=drills[j];
var id=drill.id;var breadPath=new BreadPath();for(var k=0;k<drill.elements.length;k++){var element=drill.elements[k];breadPath.pushElement(new BreadPathElement(element.member,element.memberformated,element.membercaption,null,element.dimFilter,element.hFilter,element.lFilter,element.dimExpl,element.hExpl,element.lExpl,element.mapIndex));}if(typeof(state.drillPath[frameId])=="undefined"){state.drillPath[frameId]={};}state.drillPath[frameId][id]=breadPath;}}}var ddvars=dashboardState.ddvars;if(ddvars){for(var i=0;i<ddvars.length;i++){var ddvar=ddvars[i];var ddvarname=ddvar.name;var ddvarvalue=ddvar.value;state.ddvars[ddvarname]=ddvarvalue;}}this.history[this.hCount]=state;};History.prototype.commitInitialState=function(doc,dm,dmsel,chart){var initState=this.history[0];if(this.hCount!=0){return;}if(initState&&initState.pageId==ddCtrl.pageID){for(var i=0;i<dm.dimensions.length;i++){var dim=dm.dimensions[i];if(initState.filtersByDim&&initState.filtersByDim[dim.id]&&!dmsel.dimensionsToExcludeForNavigation[dim.id]){var filter=initState.filtersByDim[dim.id];
if(filter.members){var origIds=getMemberPos(dim,filter.hierarchy,filter.level,filter.members);var fs=new FilterSelection(dim,filter.hierarchy,filter.level,origIds,filter.members);if(filter.exclude){fs.mode=REVERSE_MODE;}dmsel.setFilter(fs);}else{var min=null;var max=null;if(typeof(filter.min)!="undefined"&&filter.min!=null){min=filter.min;}else{if(typeof(filter.minFormula)!="undefined"&&filter.minFormula!=null){min=filter.minFormula;}}if(typeof(filter.max)!="undefined"&&filter.max!=null){max=filter.max;}else{if(typeof(filter.maxFormula)!="undefined"&&filter.maxFormula!=null){max=filter.maxFormula;}}var fs=new FilterSelectionContinuous(dim,filter.hierarchy,filter.level,min,max);filter.min=fs.min;filter.max=fs.max;if(filter.exclude){fs.mode=REVERSE_MODE;}dmsel.setFilter(fs);}}}for(var i=0;i<dmsel.dimsToExplore.length;i++){var dimEx=dmsel.dimsToExplore[i];if(dimEx.hierarchy&&dimEx.lPos>-1){if(typeof(initState.drillPath[doc.frameId])!="undefined"){if(typeof(initState.drillPath[doc.frameId][dimEx.dim.id])!="undefined"){var breadPath=initState.drillPath[doc.frameId][dimEx.dim.id];
initState.drillPath[doc.frameId][drillId]=breadPath;delete initState.drillPath[doc.frameId][dimEx.dim.id];ddCtrl.createBreadCrumb(doc,chart,dmsel);var drillObject=drillObjectList[doc.frameId][drillId];drillObject.initDrill(breadPath);}else{var drillId=dimEx.hierarchy.id;if(typeof(initState.drillPath[doc.frameId][drillId])!="undefined"){var breadPath=initState.drillPath[doc.frameId][drillId];if(breadPath!=null&&breadPath.elements.length>0&&breadPath.elements[0].lFilter==dimEx.lPos){ddCtrl.createBreadCrumb(doc,chart,dmsel);var drillObject=drillObjectList[doc.frameId][drillId];drillObject.initDrill(breadPath);}}else{if(dmsel.drillPaths[chart.clickAction.axis]){drillId=dimEx.dim.id+"_"+dmsel.drillPaths[chart.clickAction.axis].name;}else{if(dimEx.hierarchy){drillId=dimEx.dim.id+"_"+dimEx.hierarchy.id;}}if(typeof(initState.drillPath[doc.frameId][drillId])!="undefined"){var breadPath=initState.drillPath[doc.frameId][drillId];if(breadPath!=null&&breadPath.elements.length>0&&breadPath.elements[0].lFilter==dimEx.lPos){ddCtrl.createBreadCrumb(doc,chart,dmsel);
var drillObject=drillObjectList[doc.frameId][drillId];drillObject.initDrill(breadPath);}}}}}}}for(var axisId in dmsel.drillPaths){var drillPath=dmsel.drillPaths[axisId];var dimEx=drillPath.dimsExplorer[0];if(typeof(initState.drillPath[doc.frameId])!="undefined"){if(typeof(initState.drillPath[doc.frameId][dimEx.dim.id])!="undefined"){var breadPath=initState.drillPath[doc.frameId][dimEx.dim.id];initState.drillPath[doc.frameId][drillPath.name]=breadPath;delete initState.drillPath[doc.frameId][dimEx.dim.id];ddCtrl.createBreadCrumb(doc,chart,dmsel);var drillObject=drillObjectList[doc.frameId][drillPath.name];drillObject.initDrill(breadPath);}else{var drillId=drillPath.name;if(typeof(initState.drillPath[doc.frameId][drillId])!="undefined"){var breadPath=initState.drillPath[doc.frameId][drillId];ddCtrl.createBreadCrumb(doc,chart,dmsel);var drillObject=drillObjectList[doc.frameId][drillId];drillObject.initDrill(breadPath);}else{drillId=dimEx.dim.id+"_"+drillPath.name;if(typeof(initState.drillPath[doc.frameId][drillId])!="undefined"){var breadPath=initState.drillPath[doc.frameId][drillId];
ddCtrl.createBreadCrumb(doc,chart,dmsel);var drillObject=drillObjectList[doc.frameId][drillId];drillObject.initDrill(breadPath);}}}}}for(ddVarName in dm.variables){if(typeof(initState.ddvars[ddVarName])!="undefined"){var ddVarValue=initState.ddvars[ddVarName];__v[ddVarName].cur=ddVarValue;dm.variables[ddVarName]=__v[ddVarName];}}}};History.prototype.createState=function(pageId,bForce){var state=this.history[this.hCount];if(!state&&!bForce){state=new State();state.pageId=pageId;this.history[this.hCount]=state;}else{if(state.pageId!=pageId||bForce){this.hCount++;state=new State();state.pageId=pageId;this.history[this.hCount]=state;}}for(panelId in ddCtrl.dimPanelList){var panel=ddCtrl.dimPanelList[panelId];var fs=null;if(panel.isRangeFilter){fs=new FilterHistory(panel.id,-1,-1,null,null,panel.getMin(),panel.getMax(),panel.getMinFormated(),panel.getMaxFormated(),null,null,panel.reverseFilter);}else{var members=panel.getSelectedElements();if(members.length==1&&members[0]=="All"){continue;}var h=-1;
var l=-1;if(panel.hasHierarchy){if(panel.getSelectedHierarchyId()!=null){h=panel.getSelectedHierarchyId();}if(panel.getSelectedLevelId()!=null){l=panel.getSelectedLevelId();}}fs=new FilterHistory(panel.id,h,l,members,panel.getSelectedFormatedElements(),null,null,null,null,null,null,panel.reverseFilter);}this.history[this.hCount].filtersByDim[panel.id]=fs;}for(frameId in ddCtrl.drillObjectList){for(drillId in ddCtrl.drillObjectList[frameId]){var drillObj=ddCtrl.drillObjectList[frameId][drillId];var breadCrumbPath=drillObj.getBreadPath();if(typeof(state.drillPath[frameId])=="undefined"){state.drillPath[frameId]={};}state.drillPath[frameId][drillId]=breadCrumbPath;}}for(varName in __v){state.ddvars[varName]=getDDVar(varName);}var hist=this.hCount+"";if(window.registerState){window.registerState(hist,this.getState(this.hCount));}};History.prototype.onChange=function(dimSelPanel){var fs=null;if(dimSelPanel.isRangeFilter){fs=new FilterHistory(dimSelPanel.id,-1,-1,null,null,dimSelPanel.getMin(),dimSelPanel.getMax(),dimSelPanel.getMinFormated(),dimSelPanel.getMaxFormated(),null,null,dimSelPanel.reverseFilter);
}else{var h=-1;var l=-1;var members=dimSelPanel.getSelectedElements();if(members.length==1&&members[0]=="All"){fs=null;}if(dimSelPanel.hasHierarchy){if(dimSelPanel.getSelectedHierarchyId()!=null){h=dimSelPanel.getSelectedHierarchyId();}if(dimSelPanel.getSelectedLevelId()!=null){l=dimSelPanel.getSelectedLevelId();}}fs=new FilterHistory(dimSelPanel.id,h,l,members,dimSelPanel.getSelectedFormatedElements(),null,null,null,null,null,null,dimSelPanel.reverseFilter);}this.saveHistoryState(dimSelPanel.id,fs);};History.prototype.saveHistoryState=function(dimName,fs){if(this.bSaveHistoryState&&window.registerState&&ddCtrl.autoCommit){this.hCount++;var state=new State();for(frameId in ddCtrl.drillObjectList){for(drillId in ddCtrl.drillObjectList[frameId]){var drillObj=ddCtrl.drillObjectList[frameId][drillId];var breadPath=drillObj.getBreadPath();if(typeof(state.drillPath[frameId])=="undefined"){state.drillPath[frameId]={};}state.drillPath[frameId][drillId]=breadPath;}}if(dimName!=null&&fs!=null){state.filtersByDim[dimName]=fs;
var prevHistory=this.history[this.hCount-1];if(prevHistory){for(panel in dimPanelList){var dimSelPanel=dimPanelList[panel];if(dimSelPanel.id!=dimName){var prevFS=prevHistory.filtersByDim[dimSelPanel.id];if(prevFS){state.filtersByDim[dimSelPanel.id]=prevFS;}}}}}else{for(panel in dimPanelList){var dimSelPanel=dimPanelList[panel];var fs=null;if(dimSelPanel.isRangeFilter){fs=new FilterHistory(dimSelPanel.id,h,l,null,null,dimSelPanel.getMin(),dimSelPanel.panelUI.getMax(),dimSelPanel.getMinFormated(),dimSelPanel.getMaxFormated(),null,null,dimSelPanel.reverseFilter);}else{var members=dimSelPanel.getSelectedElements();if(members.length==1&&members[0]=="All"){continue;}var h=-1;var l=-1;if(dimSelPanel.hasHierarchy){if(dimSelPanel.getSelectedHierarchyId()!=null){h=dimSelPanel.getSelectedHierarchyId();}if(dimSelPanel.getSelectedLevelId()!=null){l=dimSelPanel.getSelectedLevelId();}}fs=new FilterHistory(dimSelPanel.id,h,l,members,dimSelPanel.getSelectedFormatedElements(),null,null,null,null,null,null,dimSelPanel.reverseFilter);
}if(fs!=null){state.filtersByDim[dimSelPanel.id]=fs;}}}for(varName in __v){state.ddvars[varName]=getDDVar(varName);}this.history[this.hCount]=state;var hist=this.hCount+"";window.registerState(hist,this.getState(this.hCount));}};History.prototype.changePage=function(){this.saveHistoryState(null,null);};History.prototype.getState=function(histCount){if(histCount==null||histCount==""||typeof(histCount)=="undefined"){histCount=this.hCount;}histCount-=0;var currentHistory=this.history[histCount];var xml="<DashboardHistory>";xml+="<Page>"+xmlEncode(currentHistory.pageId)+"</Page>";xml+="<Filters>";var filtersByDim=currentHistory.filtersByDim;for(var dimName in filtersByDim){var fs=filtersByDim[dimName];if(fs.members&&fs.members.length==1&&fs.members[0]=="All"){continue;}xml+=fs.toXML();}xml+="</Filters>";xml+="<Charts>";for(var i=0;i<ddCtrl.svgdocList.length;i++){var doc=ddCtrl.svgdocList[i];var frameId=null;var chartHandle=null;try{frameId=doc.frameId;chartHandle=ddCtrl.charts[frameId];}catch(e){continue;
}if(chartHandle){var chart=doc.getChart();var colorManager=chart.colorManager;var bHidden=chartIsHidden(frameId.replace("frame_",""));if(currentHistory.drillPath[frameId]||colorManager||bHidden){xml+='<Chart id="'+xmlEncode(frameId)+'" flowid="'+chartHandle.flowId+'" visible="'+!bHidden+'">';if(currentHistory.drillPath[frameId]){for(drillId in currentHistory.drillPath[frameId]){var breadCrumbPath=currentHistory.drillPath[frameId][drillId];var axis=-1;if(ddCtrl.drillObjectList&&ddCtrl.drillObjectList[frameId]&&ddCtrl.drillObjectList[frameId][drillId]){axis=ddCtrl.drillObjectList[frameId][drillId].axis;}if(breadCrumbPath&&breadCrumbPath.elements&&breadCrumbPath.elements.length>0){xml+='<Drill id="'+drillId+'" axis="'+axis+'">';xml+=breadCrumbPath.getXML();xml+="</Drill>";}}}if(colorManager){xml+="<ChartColors>";for(var mbr in colorManager.colorById){xml+='<Color id="'+xmlEncode(mbr)+'" color="'+colorManager.colorById[mbr]+'"/>';}xml+="</ChartColors>";}xml+="</Chart>";}}}xml+="</Charts>";xml+="<DDVars>";
for(ddvar in currentHistory.ddvars){xml+='<DDVar name="'+xmlEncode(ddvar)+'" value="'+currentHistory.ddvars[ddvar]+'" />';}xml+="</DDVars>";var colorManager=ddCtrl.colorManager;xml+="<Colors>";for(var role in colorManager.colorByMember){var colors=colorManager.colorByMember[role];var roleId=role;if(role==ddCtrl.username){roleId="";}for(var mbr in colors){xml+='<Color role="'+roleId+'" id="'+xmlEncode(mbr)+'" color="'+colors[mbr]+'"/>';}}for(var mbr in colorManager.colorById){var roleId="shared";var color=colorManager.colorById[mbr];xml+='<Color role="'+roleId+'" id="'+xmlEncode(mbr)+'" color="'+color+'"/>';}xml+="</Colors>";xml+="</DashboardHistory>";return xml;};History.prototype.getCurrentState=function(){return this.history[this.hCount];};History.prototype.changeState=function(histCount){if(histCount==""){histCount=0;}else{histCount-=0;}this.hCount=histCount;this.bSaveHistoryState=false;ddCtrl.beginSelection();this.changeStatePage(histCount);this.changeStateDrill(histCount);this.changeStateFilters(histCount);
this.changeStateDDVars(histCount);ddCtrl.commitSelection();this.bSaveHistoryState=true;};History.prototype.changeStateFilters=function(histCount){for(panel in dimPanelList){var dimSelPanel=dimPanelList[panel];if(this.history[histCount]&&this.history[histCount].filtersByDim&&this.history[histCount].filtersByDim[dimSelPanel.id]){var fs=this.history[histCount].filtersByDim[dimSelPanel.id];if(fs.members){dimSelPanel.selectMembers(fs.hierarchy,fs.level,fs.members,fs.membersFormated,false,fs.exclude);}else{if(typeof(fs.min)!="undefined"&&fs.min!=null&&typeof(fs.max)!="undefined"&&fs.max!=null){dimSelPanel.setReverseFilter(fs.exclude);dimSelPanel.setRange(fs.min,fs.max,null,true);}}}else{dimSelPanel.selectMemberAll();dimSelPanel.filter=null;}}};History.prototype.changeStatePage=function(histCount){if(this.history[histCount]&&this.history[histCount].pageId!=ddCtrl.pageID){switch_page(this.history[histCount].pageId);}};History.prototype.changeStateDrill=function(histCount){for(frameId in ddCtrl.drillObjectList){for(drillId in ddCtrl.drillObjectList[frameId]){var drillObject=ddCtrl.drillObjectList[frameId][drillId];
if(this.history[histCount].drillPath&&this.history[histCount].drillPath[frameId]&&this.history[histCount].drillPath[frameId][drillId]){var breadPath=this.history[histCount].drillPath[frameId][drillId];drillObject.drillTo(breadPath);}else{drillObject.resetChart();}}}};History.prototype.changeStateDDVars=function(histCount){for(ddVarName in this.history[histCount].ddvars){var ddVarValue=this.history[histCount].ddvars[ddVarName];ddCtrl.changeVariable(ddVarName,ddVarValue);}};History.prototype.reset=function(){this.hCount++;this.history[this.hCount]=this.history[0];var hist=this.hCount+"";window.registerState(hist,this.getState(this.hCount));this.changeState(this.hCount);};State=function(){this.filtersByDim={};this.drillPath={};this.pageId=ddCtrl.pageID;this.ddvars={};};FilterHistory=function(dimension,hierarchy,level,members,membersFormated,min,max,minFormated,maxFormated,minFormula,maxFormula,exclude){this.dimension=dimension;this.hierarchy=hierarchy;this.level=level;this.members=members;
this.membersFormated=membersFormated;this.min=min;this.max=max;this.minFormated=minFormated;this.maxFormated=maxFormated;this.minFormula=minFormula;this.maxFormula=maxFormula;if(typeof(exclude)=="undefined"){this.exclude=false;}else{this.exclude=exclude;}};FilterHistory.prototype.toXML=function(){var xml="";if(this.members){xml+='<Filter dimension="'+xmlEncode(this.dimension)+'" hierarchy="'+this.hierarchy+'" level="'+this.level+'" exclude="'+this.exclude+'">';for(var iMbr=0;iMbr<this.members.length;iMbr++){xml+="<Member>"+xmlEncode(this.members[iMbr])+"</Member>";}for(var iMbr=0;iMbr<this.membersFormated.length;iMbr++){xml+="<MemberFormated>"+xmlEncode(this.membersFormated[iMbr])+"</MemberFormated>";}xml+="</Filter>";}else{if(typeof(this.min)!="undefined"&&this.min!=null&&typeof(this.max)!="undefined"&&this.max!=null){xml+='<Filter dimension="'+xmlEncode(this.dimension)+'" hierarchy="'+this.hierarchy+'" level="'+this.level+'" min="'+this.min+'" max="'+this.max+'" minFormated="'+this.minFormated+'" maxFormated="'+this.maxFormated+'" exclude="'+this.exclude+'"/>';
}}return xml;};